name: Lint and Test

on:
  push:
    branches:
      - main
      - beta

  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

  merge_group:

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  prefetch:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

  pre-commit:
    # Skip pre-commit on `main` because the `no-commit-to-branch` hook won't
    # allow it.
    if: ${{ github.ref != 'refs/heads/main' }}
    needs: [prefetch]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.12"

      - uses: pre-commit/action@v3.0.1

  lint-ruff:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: ruff
        run: uv run ruff check .

  lint-mypy:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: mypy
        run: uv run mypy .

  sdk-test-unit:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        working-directory: ./packages/pangea-sdk
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: Unit test
        run: uv run pytest tests/unit/

  sdk-test-integration:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        working-directory: ./packages/pangea-sdk
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: Integration tests
        run: bash ./scripts/test.sh

  sdk-docs:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: ./packages/pangea-sdk
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: Generate docs
        run: uv run parse_module.py > python_sdk.json

      - name: Upload
        uses: actions/upload-artifact@v5.0.0
        with:
          name: python_sdk.json
          path: ./packages/pangea-sdk/python_sdk.json

  django-test-unit:
    needs: [prefetch]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        working-directory: ./packages/pangea-django
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --all-packages --dev

      - name: Unit test
        run: uv run pytest
